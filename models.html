<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Models &mdash; CDTools 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=938c9ccc"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tools" href="tools/index.html" />
    <link rel="prev" title="Datasets" href="datasets.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            CDTools
          </a>
              <div class="version">
                0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Introduction to CDTools</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="general.html">General Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Datasets</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.CDIModel"><code class="docutils literal notranslate"><span class="pre">CDIModel</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.__init__"><code class="docutils literal notranslate"><span class="pre">CDIModel.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.forward"><code class="docutils literal notranslate"><span class="pre">CDIModel.forward()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.store_detector_geometry"><code class="docutils literal notranslate"><span class="pre">CDIModel.store_detector_geometry()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.get_detector_geometry"><code class="docutils literal notranslate"><span class="pre">CDIModel.get_detector_geometry()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.save_results"><code class="docutils literal notranslate"><span class="pre">CDIModel.save_results()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.save_to_h5"><code class="docutils literal notranslate"><span class="pre">CDIModel.save_to_h5()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.save_on_exit"><code class="docutils literal notranslate"><span class="pre">CDIModel.save_on_exit()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.save_on_exception"><code class="docutils literal notranslate"><span class="pre">CDIModel.save_on_exception()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.skip_computation"><code class="docutils literal notranslate"><span class="pre">CDIModel.skip_computation()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.AD_optimize"><code class="docutils literal notranslate"><span class="pre">CDIModel.AD_optimize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.Adam_optimize"><code class="docutils literal notranslate"><span class="pre">CDIModel.Adam_optimize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.LBFGS_optimize"><code class="docutils literal notranslate"><span class="pre">CDIModel.LBFGS_optimize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.SGD_optimize"><code class="docutils literal notranslate"><span class="pre">CDIModel.SGD_optimize()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.report"><code class="docutils literal notranslate"><span class="pre">CDIModel.report()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.inspect"><code class="docutils literal notranslate"><span class="pre">CDIModel.inspect()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.save_figures"><code class="docutils literal notranslate"><span class="pre">CDIModel.save_figures()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.CDIModel.compare"><code class="docutils literal notranslate"><span class="pre">CDIModel.compare()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.SimplePtycho"><code class="docutils literal notranslate"><span class="pre">SimplePtycho</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.SimplePtycho.__init__"><code class="docutils literal notranslate"><span class="pre">SimplePtycho.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.SimplePtycho.save_results"><code class="docutils literal notranslate"><span class="pre">SimplePtycho.save_results()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.FancyPtycho"><code class="docutils literal notranslate"><span class="pre">FancyPtycho</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.FancyPtycho.__init__"><code class="docutils literal notranslate"><span class="pre">FancyPtycho.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.FancyPtycho.center_probes"><code class="docutils literal notranslate"><span class="pre">FancyPtycho.center_probes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.FancyPtycho.tidy_probes"><code class="docutils literal notranslate"><span class="pre">FancyPtycho.tidy_probes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.FancyPtycho.save_results"><code class="docutils literal notranslate"><span class="pre">FancyPtycho.save_results()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.Bragg2DPtycho"><code class="docutils literal notranslate"><span class="pre">Bragg2DPtycho</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.Bragg2DPtycho.__init__"><code class="docutils literal notranslate"><span class="pre">Bragg2DPtycho.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.Bragg2DPtycho.save_results"><code class="docutils literal notranslate"><span class="pre">Bragg2DPtycho.save_results()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.Multislice2DPtycho"><code class="docutils literal notranslate"><span class="pre">Multislice2DPtycho</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.Multislice2DPtycho.__init__"><code class="docutils literal notranslate"><span class="pre">Multislice2DPtycho.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.Multislice2DPtycho.to"><code class="docutils literal notranslate"><span class="pre">Multislice2DPtycho.to()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.Multislice2DPtycho.tidy_probes"><code class="docutils literal notranslate"><span class="pre">Multislice2DPtycho.tidy_probes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.Multislice2DPtycho.save_results"><code class="docutils literal notranslate"><span class="pre">Multislice2DPtycho.save_results()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.MultislicePtycho"><code class="docutils literal notranslate"><span class="pre">MultislicePtycho</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.MultislicePtycho.__init__"><code class="docutils literal notranslate"><span class="pre">MultislicePtycho.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.MultislicePtycho.center_probes"><code class="docutils literal notranslate"><span class="pre">MultislicePtycho.center_probes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.MultislicePtycho.tidy_probes"><code class="docutils literal notranslate"><span class="pre">MultislicePtycho.tidy_probes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.MultislicePtycho.save_results"><code class="docutils literal notranslate"><span class="pre">MultislicePtycho.save_results()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cdtools.models.RPI"><code class="docutils literal notranslate"><span class="pre">RPI</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.RPI.__init__"><code class="docutils literal notranslate"><span class="pre">RPI.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.RPI.get_obj_shape_and_n_modes"><code class="docutils literal notranslate"><span class="pre">RPI.get_obj_shape_and_n_modes()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.RPI.uniform_init"><code class="docutils literal notranslate"><span class="pre">RPI.uniform_init()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.RPI.random_init"><code class="docutils literal notranslate"><span class="pre">RPI.random_init()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.RPI.spectral_init"><code class="docutils literal notranslate"><span class="pre">RPI.spectral_init()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#cdtools.models.RPI.save_results"><code class="docutils literal notranslate"><span class="pre">RPI.save_results()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools/index.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="indices_tables.html">Indices and tables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CDTools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Models</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/models.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-cdtools.models">
<span id="models"></span><h1>Models<a class="headerlink" href="#module-cdtools.models" title="Link to this heading"></a></h1>
<p>This module contains all the models for different CDI Reconstructions</p>
<p>All the reconstructions are coordinated through the ptychography models
defined here. The models are, at their core, just subclasses of the
<code class="code docutils literal notranslate"><span class="pre">torch.nn.model</span></code> class, so they contain the same structure of
parameters, etc. Their central functionality is as a simulation that maps
some input (usually, the index number of a scan point) to an output that
corresponds to the measured data (usually, a diffraction pattern). This
model can then be used as the heart of an automatic differentiation
reconstruction which retrieves the parameters that were used in the model.</p>
<p>A main CDIModel class is defined in the base.py file, and models for
various CDI geometries can be defined as subclasses of this base model.
The subclasses of the main CDIModel class are required to implement a set of
functions defined in the base.py file. Example implementations of
these functions can be found in the code for the SimplePtycho class.</p>
<p>Finally, it is recommended to read through the tutorial section on
defining a new ptychography model before attempting to do so.</p>
<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.CDIModel">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">CDIModel</span></span><a class="headerlink" href="#cdtools.models.CDIModel" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>This base model defines all the functions that must be exposed for a valid CDIModel subclass</p>
<p>Most of the functions only raise a NotImplementedError at this level and
must be explicitly defined by any subclass - these are noted explocitly
in the module-level intro. The work of defining the various subclasses
boils down to creating an appropriate implementation for this set of
functions.</p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.forward" title="Link to this definition"></a></dt>
<dd><p>The complete forward model</p>
<p>This model relies on composing the interaction, forward propagator,
and measurement functions which are required to be defined by all
subclasses. It therefore should not be redefined by the subclasses.</p>
<p>The arguments to this function, for any given subclass, will be
the same as the arguments to the interaction function.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.store_detector_geometry">
<span class="sig-name descname"><span class="pre">store_detector_geometry</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.store_detector_geometry" title="Link to this definition"></a></dt>
<dd><p>Registers the information in a detector geometry dictionary</p>
<p>Information about the detector geometry is passed in as a dictionary,
but we want the various properties to be registered as buffers in
the model. This has nice effects, for example automatically updating
with model.to, and making it possible to automatically save them out.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>detector_geometry</strong> (<em>dict</em>) – A dictionary containing at least the two entries ‘distance’ and ‘basis’</p></li>
<li><p><strong>dtype</strong> (<em>torch.dtype</em><em>, </em><em>default: torch.float32</em>) – The datatype to convert the values to before registering</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.get_detector_geometry">
<span class="sig-name descname"><span class="pre">get_detector_geometry</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.get_detector_geometry" title="Link to this definition"></a></dt>
<dd><p>Makes a detector geometry dictionary from the registered buffers</p>
<p>This extracts a dictionary with the detector geometry data from
the registered buffers, helpful for functions which expect the
geometry data to be in this format.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>detector_geometry</strong> – A dictionary containing at least the two entries ‘distance’ and ‘basis’, pulled from the model’s buffers</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.save_to_h5">
<span class="sig-name descname"><span class="pre">save_to_h5</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filename</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.save_to_h5" title="Link to this definition"></a></dt>
<dd><p>Saves the results to a .mat file</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>filename</strong> (<em>str</em>) – The filename to save under</p></li>
<li><p><strong>*args</strong> – Accepts any additional args that model.save_results needs, for this model</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.save_on_exit">
<span class="sig-name descname"><span class="pre">save_on_exit</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filename</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exception_filename</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.save_on_exit" title="Link to this definition"></a></dt>
<dd><p>Saves the results of the model when the context is exited</p>
<p>If you wrap the main body of your code in this context manager,
it will either save the results to a .h5 file upon completion,
or when any exception is raised during execution.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>filename</strong> (<em>str</em>) – The filename to save under, upon completion</p></li>
<li><p><strong>*args</strong> – Accepts any additional args that model.save_results needs, for this model</p></li>
<li><p><strong>exception_filename</strong> (<em>str</em>) – Optional, a separate filename to use if an exception is raised during execution. Default is equal to filename</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.save_on_exception">
<span class="sig-name descname"><span class="pre">save_on_exception</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">filename</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.save_on_exception" title="Link to this definition"></a></dt>
<dd><p>Saves the results of the model if an exception occurs</p>
<p>If you wrap the main body of your code in this context manager,
it will save the results to a .h5 file if an exception is thrown.
If the code completes without an exception, it will not save the
results, expecting that the results are explicitly saved later</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>filename</strong> (<em>str</em>) – The filename to save under, in case of an exception</p></li>
<li><p><strong>*args</strong> – Accepts any additional args that model.save_results needs, for this model</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.skip_computation">
<span class="sig-name descname"><span class="pre">skip_computation</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.skip_computation" title="Link to this definition"></a></dt>
<dd><p>Returns true if computations should be skipped due to checkpointing</p>
<p>This is used internally by model.AD_optimize to make the checkpointing
system work, but it is also useful to suppress printing when
computations are being skipped</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.AD_optimize">
<span class="sig-name descname"><span class="pre">AD_optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data_loader</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">optimizer</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scheduler</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">regularization_factor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">thread</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">calculation_width</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.AD_optimize" title="Link to this definition"></a></dt>
<dd><p>Runs a round of reconstruction using the provided optimizer</p>
<p>This is the basic automatic differentiation reconstruction tool
which all the other, algorithm-specific tools, use. It is a
generator which yields the average loss each epoch, ending after
the specified number of iterations.</p>
<p>By default, the computation will be run in a separate thread. This
is done to enable live plotting with matplotlib during a reconstruction.
If the computation was done in the main thread, this would freeze
the plots. This behavior can be turned off by setting the keyword
argument ‘thread’ to False.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>iterations</strong> (<em>int</em>) – How many epochs of the algorithm to run</p></li>
<li><p><strong>data_loader</strong> (<em>torch.utils.data.DataLoader</em>) – A data loader loading the CDataset to reconstruct</p></li>
<li><p><strong>optimizer</strong> (<em>torch.optim.Optimizer</em>) – The optimizer to run the reconstruction with</p></li>
<li><p><strong>scheduler</strong> (<em>torch.optim.lr_scheduler._LRScheduler</em>) – Optional, a learning rate scheduler to use</p></li>
<li><p><strong>regularization_factor</strong> (<em>float</em><em> or </em><em>list</em><em>(</em><em>float</em><em>)</em>) – Optional, if the model has a regularizer defined, the set of parameters to pass the regularizer method</p></li>
<li><p><strong>thread</strong> (<em>bool</em>) – Default True, whether to run the computation in a separate thread to allow interaction with plots during computation</p></li>
<li><p><strong>calculation_width</strong> (<em>int</em>) – Default 10, how many translations to pass through at once for each round of gradient accumulation. This does not affect the result, but may affect the calculation speed.</p></li>
</ul>
</dd>
<dt class="field-even">Yields<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>loss</strong> (<em>float</em>) – The summed loss over the latest epoch, divided by the total diffraction pattern intensity</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.Adam_optimize">
<span class="sig-name descname"><span class="pre">Adam_optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">batch_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">15</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lr</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.005</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">betas</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(0.9,</span> <span class="pre">0.999)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">schedule</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">amsgrad</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">regularization_factor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">thread</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">calculation_width</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.Adam_optimize" title="Link to this definition"></a></dt>
<dd><p>Runs a round of reconstruction using the Adam optimizer</p>
<p>This is generally accepted to be the most robust algorithm for use
with ptychography. Like all the other optimization routines,
it is defined as a generator function, which yields the average
loss each epoch.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>iterations</strong> (<em>int</em>) – How many epochs of the algorithm to run</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="datasets.html#cdtools.datasets.CDataset" title="cdtools.datasets.CDataset"><em>CDataset</em></a>) – The dataset to reconstruct against</p></li>
<li><p><strong>batch_size</strong> (<em>int</em>) – Optional, the size of the minibatches to use</p></li>
<li><p><strong>lr</strong> (<em>float</em>) – Optional, The learning rate (alpha) to use. Defaultis 0.005. 0.05 is typically the highest possible value with any chance of being stable</p></li>
<li><p><strong>betas</strong> (<em>tuple</em>) – Optional, the beta_1 and beta_2 to use. Default is (0.9, 0.999).</p></li>
<li><p><strong>schedule</strong> (<em>float</em>) – Optional, whether to use the ReduceLROnPlateau scheduler</p></li>
<li><p><strong>subset</strong> (<em>list</em><em>(</em><em>int</em><em>) or </em><em>int</em>) – Optional, a pattern index or list of pattern indices to use</p></li>
<li><p><strong>regularization_factor</strong> (<em>float</em><em> or </em><em>list</em><em>(</em><em>float</em><em>)</em>) – Optional, if the model has a regularizer defined, the set of parameters to pass the regularizer method</p></li>
<li><p><strong>thread</strong> (<em>bool</em>) – Default True, whether to run the computation in a separate thread to allow interaction with plots during computation</p></li>
<li><p><strong>calculation_width</strong> (<em>int</em>) – Default 10, how many translations to pass through at once for each round of gradient accumulation. Does not affect the result, only the calculation speed</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.LBFGS_optimize">
<span class="sig-name descname"><span class="pre">LBFGS_optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lr</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">history_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">regularization_factor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">thread</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">calculation_width</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">line_search_fn</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.LBFGS_optimize" title="Link to this definition"></a></dt>
<dd><p>Runs a round of reconstruction using the L-BFGS optimizer</p>
<p>This algorithm is often less stable that Adam, however in certain
situations or geometries it can be shockingly efficient. Like all
the other optimization routines, it is defined as a generator
function which yields the average loss each epoch.</p>
<p>Note: There is no batch size, because it is a usually a bad idea to use
LBFGS on anything but all the data at onece</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>iterations</strong> (<em>int</em>) – How many epochs of the algorithm to run</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="datasets.html#cdtools.datasets.CDataset" title="cdtools.datasets.CDataset"><em>CDataset</em></a>) – The dataset to reconstruct against</p></li>
<li><p><strong>lr</strong> (<em>float</em>) – Optional, the learning rate to use</p></li>
<li><p><strong>history_size</strong> (<em>int</em>) – Optional, the length of the history to use.</p></li>
<li><p><strong>subset</strong> (<em>list</em><em>(</em><em>int</em><em>) or </em><em>int</em>) – Optional, a pattern index or list of pattern indices to ues</p></li>
<li><p><strong>regularization_factor</strong> (<em>float</em><em> or </em><em>list</em><em>(</em><em>float</em><em>)</em>) – Optional, if the model has a regularizer defined, the set of parameters to pass the regularizer method</p></li>
<li><p><strong>thread</strong> (<em>bool</em>) – Default True, whether to run the computation in a separate thread to allow interaction with plots during computation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.SGD_optimize">
<span class="sig-name descname"><span class="pre">SGD_optimize</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">batch_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lr</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.01</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">momentum</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dampening</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_decay</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nesterov</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">regularization_factor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">thread</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">calculation_width</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.SGD_optimize" title="Link to this definition"></a></dt>
<dd><p>Runs a round of reconstruction using the SGD optimizer</p>
<p>This algorithm is often less stable that Adam, but it is simpler
and is the basic workhorse of gradience descent.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>iterations</strong> (<em>int</em>) – How many epochs of the algorithm to run</p></li>
<li><p><strong>dataset</strong> (<a class="reference internal" href="datasets.html#cdtools.datasets.CDataset" title="cdtools.datasets.CDataset"><em>CDataset</em></a>) – The dataset to reconstruct against</p></li>
<li><p><strong>batch_size</strong> (<em>int</em>) – Optional, the size of the minibatches to use</p></li>
<li><p><strong>lr</strong> (<em>float</em>) – Optional, the learning rate to use</p></li>
<li><p><strong>momentum</strong> (<em>float</em>) – Optional, the length of the history to use.</p></li>
<li><p><strong>subset</strong> (<em>list</em><em>(</em><em>int</em><em>) or </em><em>int</em>) – Optional, a pattern index or list of pattern indices to use</p></li>
<li><p><strong>regularization_factor</strong> (<em>float</em><em> or </em><em>list</em><em>(</em><em>float</em><em>)</em>) – Optional, if the model has a regularizer defined, the set of parameters to pass the regularizer method</p></li>
<li><p><strong>thread</strong> (<em>bool</em>) – Default True, whether to run the computation in a separate thread to allow interaction with plots during computation</p></li>
<li><p><strong>calculation_width</strong> (<em>int</em>) – Default 1, how many translations to pass through at once for each round of gradient accumulation</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.report">
<span class="sig-name descname"><span class="pre">report</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.report" title="Link to this definition"></a></dt>
<dd><p>Returns a string with info about the latest reconstruction iteration</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>report</strong> – A string with basic info on the latest iteration</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.inspect">
<span class="sig-name descname"><span class="pre">inspect</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.inspect" title="Link to this definition"></a></dt>
<dd><p>Plots all the plots defined in the model’s plot_list attribute</p>
<p>If update is set to True, it will update any previously plotted set
of plots, if one exists, and then redraw them. Otherwise, it will
plot a new set, and any subsequent updates will update the new set</p>
<p>Optionally, a dataset can be passed, which will allow plotting of any
registered plots which need to incorporate some information from
the dataset (such as geometry or a comparison with measured data).</p>
<p>Plots can be registered in any subclass by defining the plot_list
attribute. This should be a list of tuples in the following format:
( ‘Plot Title’, function_to_generate_plot(self),
function_to_determine_whether_to_plot(self))</p>
<p>Where the third element in the tuple (a function that returns
True if the plot is relevant) is not required.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dataset</strong> (<a class="reference internal" href="datasets.html#cdtools.datasets.CDataset" title="cdtools.datasets.CDataset"><em>CDataset</em></a>) – Optional, a dataset matched to the model type</p></li>
<li><p><strong>update</strong> (<em>bool</em><em>, </em><em>default: True</em>) – Whether to update existing plots or plot new ones</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.save_figures">
<span class="sig-name descname"><span class="pre">save_figures</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">extension</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'.pdf'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.save_figures" title="Link to this definition"></a></dt>
<dd><p>Saves all currently open inspection figures.</p>
<p>Note that this function is not very intelligent - so, for example,
if multiple probe modes are being reconstructed and the probe
plotting function allows one to scroll between different modes, it
will simply save whichever mode happens to be showing at the moment.
Therefore, this should not be treated as a good way of saving out
the full state of the reconstruction.</p>
<p>By default, the files will be named by the figure titles as defined
in the plot_list. Files can be saved with any extension suported by
matplotlib.pyplot.savefig.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>prefix</strong> (<em>str</em>) – Optional, a string to prepend to the saved figure names</p></li>
<li><p><strong>extention</strong> (<em>strategy</em>) – Default is .eps, the file extension to save with.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.CDIModel.compare">
<span class="sig-name descname"><span class="pre">compare</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">logarithmic</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.CDIModel.compare" title="Link to this definition"></a></dt>
<dd><p>Opens a tool for comparing simulated and measured diffraction patterns</p>
<p>This does what it says on the tin.</p>
<p>Also, I am very sorry, the implementation was done while I was
possessed by Beezlebub - do not try to fix this, if it breaks just
kill it and start from scratch.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>dataset</strong> (<a class="reference internal" href="datasets.html#cdtools.datasets.CDataset" title="cdtools.datasets.CDataset"><em>CDataset</em></a>) – A dataset containing the simulated diffraction patterns to compare against</p></li>
<li><p><strong>logarithmic</strong> (<em>bool</em><em>, </em><em>default: False</em>) – Whether to plot the diffraction on a logarithmic scale</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.SimplePtycho">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">SimplePtycho</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[0,</span> <span class="pre">0]</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.SimplePtycho" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#cdtools.models.CDIModel" title="cdtools.models.base.CDIModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">CDIModel</span></code></a></p>
<p>A simple ptychography model to demonstrate the structure of a model</p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.SimplePtycho.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">[0,</span> <span class="pre">0]</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.SimplePtycho.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.SimplePtycho.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.SimplePtycho.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.FancyPtycho">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">FancyPtycho</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surface_normal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.,</span> <span class="pre">1.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fourier_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loss</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'amplitude</span> <span class="pre">mse'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_probe_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_finite_pixels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">phase_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_view_crop</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.FancyPtycho" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#cdtools.models.CDIModel" title="cdtools.models.base.CDIModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">CDIModel</span></code></a></p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.FancyPtycho.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surface_normal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.,</span> <span class="pre">1.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fourier_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loss</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'amplitude</span> <span class="pre">mse'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_probe_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_finite_pixels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">phase_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_view_crop</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.FancyPtycho.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.FancyPtycho.center_probes">
<span class="sig-name descname"><span class="pre">center_probes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterations</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.FancyPtycho.center_probes" title="Link to this definition"></a></dt>
<dd><p>Centers the probes</p>
<p>Note that this does not compensate for the centering by adjusting
the object, so it’s a good idea to reset the object after centering
the probes</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.FancyPtycho.tidy_probes">
<span class="sig-name descname"><span class="pre">tidy_probes</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.FancyPtycho.tidy_probes" title="Link to this definition"></a></dt>
<dd><p>Tidies up the probes</p>
<p>What we want to do here is use all the information on all the probes
to calculate a natural basis for the experiment, and update all the
density matrices to operate in that updated basis</p>
<p>As a first step, we calculate the state of the light field across the
full experiment, using the weight matrices and basis probes. Then, we
use an SVD to update the basis probes so they form an eigenbasis of
the implied density matrix for the full experiment.</p>
<p>Next, the weight matrices for each shot are recalculated so that the
probes generated by weights * basis_probes for each shot are themselves
an eigenbasis for that individual shot’s density matrix.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.FancyPtycho.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.FancyPtycho.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.Bragg2DPtycho">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">Bragg2DPtycho</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">median_propagation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor(0.)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">propagate_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_tilt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lens</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Bragg2DPtycho" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#cdtools.models.CDIModel" title="cdtools.models.base.CDIModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">CDIModel</span></code></a></p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.Bragg2DPtycho.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">median_propagation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor(0.)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">propagate_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">correct_tilt</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lens</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Bragg2DPtycho.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.Bragg2DPtycho.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Bragg2DPtycho.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.Multislice2DPtycho">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">Multislice2DPtycho</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dz</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nz</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_slice</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surface_normal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">array([0.,</span> <span class="pre">0.,</span> <span class="pre">1.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bandlimit</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subpixel</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fourier_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prevent_aliasing</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">phase_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Multislice2DPtycho" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#cdtools.models.CDIModel" title="cdtools.models.base.CDIModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">CDIModel</span></code></a></p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.Multislice2DPtycho.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dz</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nz</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_slice</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surface_normal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">array([0.,</span> <span class="pre">0.,</span> <span class="pre">1.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bandlimit</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">subpixel</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fourier_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prevent_aliasing</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">phase_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Multislice2DPtycho.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.Multislice2DPtycho.to">
<span class="sig-name descname"><span class="pre">to</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Multislice2DPtycho.to" title="Link to this definition"></a></dt>
<dd><p>Move and/or cast the parameters and buffers.</p>
<p>This can be called as</p>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">to</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">device</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">non_blocking</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">to</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dtype</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">non_blocking</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">to</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">tensor</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">non_blocking</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span></dt>
<dd></dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">to</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">memory_format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.channels_last</span></span></em><span class="sig-paren">)</span></dt>
<dd></dd></dl>

<p>Its signature is similar to <code class="xref py py-meth docutils literal notranslate"><span class="pre">torch.Tensor.to()</span></code>, but only accepts
floating point or complex <code class="xref py py-attr docutils literal notranslate"><span class="pre">dtype</span></code>s. In addition, this method will
only cast the floating point or complex parameters and buffers to <code class="xref py py-attr docutils literal notranslate"><span class="pre">dtype</span></code>
(if given). The integral parameters and buffers will be moved
<code class="xref py py-attr docutils literal notranslate"><span class="pre">device</span></code>, if that is given, but with dtypes unchanged. When
<code class="xref py py-attr docutils literal notranslate"><span class="pre">non_blocking</span></code> is set, it tries to convert/move asynchronously
with respect to the host if possible, e.g., moving CPU Tensors with
pinned memory to CUDA devices.</p>
<p>See below for examples.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method modifies the module in-place.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>device</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.device</span></code>) – the desired device of the parameters
and buffers in this module</p></li>
<li><p><strong>dtype</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.dtype</span></code>) – the desired floating point or complex dtype of
the parameters and buffers in this module</p></li>
<li><p><strong>tensor</strong> (<em>torch.Tensor</em>) – Tensor whose dtype and device are the desired
dtype and device for all parameters and buffers in this module</p></li>
<li><p><strong>memory_format</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.memory_format</span></code>) – the desired memory
format for 4D parameters and buffers in this module (keyword
only argument)</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>self</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>Module</p>
</dd>
</dl>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># xdoctest: +IGNORE_WANT(&quot;non-deterministic&quot;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span>
<span class="go">Parameter containing:</span>
<span class="go">tensor([[ 0.1913, -0.3420],</span>
<span class="go">        [-0.5113, -0.2325]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="go">Linear(in_features=2, out_features=2, bias=True)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span>
<span class="go">Parameter containing:</span>
<span class="go">tensor([[ 0.1913, -0.3420],</span>
<span class="go">        [-0.5113, -0.2325]], dtype=torch.float64)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># xdoctest: +REQUIRES(env:TORCH_DOCTEST_CUDA1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gpu1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gpu1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">half</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">Linear(in_features=2, out_features=2, bias=True)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span>
<span class="go">Parameter containing:</span>
<span class="go">tensor([[ 0.1914, -0.3420],</span>
<span class="go">        [-0.5112, -0.2324]], dtype=torch.float16, device=&#39;cuda:1&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cpu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
<span class="go">Linear(in_features=2, out_features=2, bias=True)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span>
<span class="go">Parameter containing:</span>
<span class="go">tensor([[ 0.1914, -0.3420],</span>
<span class="go">        [-0.5112, -0.2324]], dtype=torch.float16)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cdouble</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="o">.</span><span class="n">weight</span>
<span class="go">Parameter containing:</span>
<span class="go">tensor([[ 0.3741+0.j,  0.2382+0.j],</span>
<span class="go">        [ 0.5593+0.j, -0.4443+0.j]], dtype=torch.complex128)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">linear</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cdouble</span><span class="p">))</span>
<span class="go">tensor([[0.6122+0.j, 0.1150+0.j],</span>
<span class="go">        [0.6122+0.j, 0.1150+0.j],</span>
<span class="go">        [0.6122+0.j, 0.1150+0.j]], dtype=torch.complex128)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.Multislice2DPtycho.tidy_probes">
<span class="sig-name descname"><span class="pre">tidy_probes</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Multislice2DPtycho.tidy_probes" title="Link to this definition"></a></dt>
<dd><p>Tidies up the probes</p>
<p>What we want to do here is use all the information on all the probes
to calculate a natural basis for the experiment, and update all the
density matrices to operate in that updated basis</p>
<p>As a first step, we calculate the state of the light field across the
full experiment, using the weight matrices and basis probes. Then, we
use an SVD to update the basis probes so they form an eigenbasis of
the implied density matrix for the full experiment.</p>
<p>Next, the weight matrices for each shot are recalculated so that the
probes generated by weights * basis_probes for each shot are themselves
an eigenbasis for that individual shot’s density matrix.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.Multislice2DPtycho.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.Multislice2DPtycho.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.MultislicePtycho">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">MultislicePtycho</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interslice_propagator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surface_normal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.,</span> <span class="pre">1.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fourier_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loss</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'amplitude</span> <span class="pre">mse'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_probe_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_finite_pixels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_view_crop</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.MultislicePtycho" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#cdtools.models.CDIModel" title="cdtools.models.base.CDIModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">CDIModel</span></code></a></p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.MultislicePtycho.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interslice_propagator</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">surface_normal</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.,</span> <span class="pre">1.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">tensor([0.,</span> <span class="pre">0.])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_offsets</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weights</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">translation_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fourier_probe</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loss</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'amplitude</span> <span class="pre">mse'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_probe_translation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">simulate_finite_pixels</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_view_crop</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.MultislicePtycho.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.MultislicePtycho.center_probes">
<span class="sig-name descname"><span class="pre">center_probes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iterations</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.MultislicePtycho.center_probes" title="Link to this definition"></a></dt>
<dd><p>Centers the probes</p>
<p>Note that this does not compensate for the centering by adjusting
the object, so it’s a good idea to reset the object after centering
the probes</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.MultislicePtycho.tidy_probes">
<span class="sig-name descname"><span class="pre">tidy_probes</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.MultislicePtycho.tidy_probes" title="Link to this definition"></a></dt>
<dd><p>Tidies up the probes</p>
<p>What we want to do here is use all the information on all the probes
to calculate a natural basis for the experiment, and update all the
density matrices to operate in that updated basis</p>
<p>As a first step, we calculate the state of the light field across the
full experiment, using the weight matrices and basis probes. Then, we
use an SVD to update the basis probes so they form an eigenbasis of
the implied density matrix for the full experiment.</p>
<p>Next, the weight matrices for each shot are recalculated so that the
probes generated by weights * basis_probes for each shot are themselves
an eigenbasis for that individual shot’s density matrix.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.MultislicePtycho.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.MultislicePtycho.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="cdtools.models.RPI">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">cdtools.models.</span></span><span class="sig-name descname"><span class="pre">RPI</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_matrix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">phase_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">propagation_distance</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference internal" href="#cdtools.models.CDIModel" title="cdtools.models.base.CDIModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">CDIModel</span></code></a></p>
<p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.RPI.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wavelength</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">detector_geometry</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe_basis</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">probe</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_guess</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">saturation</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_support</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">oversampling</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_matrix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exponentiate_obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">phase_only</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">propagation_distance</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">units</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'um'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dtype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">torch.float32</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.RPI.get_obj_shape_and_n_modes">
<span class="sig-name descname"><span class="pre">get_obj_shape_and_n_modes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj_shape</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_modes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI.get_obj_shape_and_n_modes" title="Link to this definition"></a></dt>
<dd><p>Sets defaults for obj shape and n modes</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.RPI.uniform_init">
<span class="sig-name descname"><span class="pre">uniform_init</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj_shape</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_modes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI.uniform_init" title="Link to this definition"></a></dt>
<dd><p>Sets a uniform object initialization</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.RPI.random_init">
<span class="sig-name descname"><span class="pre">random_init</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">obj_shape</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_modes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI.random_init" title="Link to this definition"></a></dt>
<dd><p>Sets a uniform amplitude object initialization with random phase</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.RPI.spectral_init">
<span class="sig-name descname"><span class="pre">spectral_init</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pattern</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj_shape</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_modes</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI.spectral_init" title="Link to this definition"></a></dt>
<dd><p>Initializes the object with a spectral method</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="cdtools.models.RPI.save_results">
<span class="sig-name descname"><span class="pre">save_results</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dataset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#cdtools.models.RPI.save_results" title="Link to this definition"></a></dt>
<dd><p>A convenience function to get the state dict as numpy arrays</p>
<p>This function exists for two reasons, even though it is just a thin
wrapper on top of t.module.state_dict(). First, because the model
parameters for Automatic Differentiation ptychography and
related CDI methods <em>are</em> the results, it’s nice to explicitly
recognize the role of extracting the state_dict as saving the
results of the reconstruction</p>
<p>Second, because display, further processing, long-term storage,
etc. are often done with dictionaries of numpy arrays. So, it’s useful
to have a convenience function which does that conversion
automatically.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>results</strong> – A dictionary containing all the parameters and buffers of the model, i.e. the result of self.state_dict(), converted to numpy.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>dict</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="datasets.html" class="btn btn-neutral float-left" title="Datasets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools/index.html" class="btn btn-neutral float-right" title="Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2024, Abraham Levitan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>